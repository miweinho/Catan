<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Status</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        #map { height: 400px; width: 100%; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>
    <h1>Location Status</h1>
    <a href="/">Back to Check Location</a>
    <div id="map"></div>
    <table id="locationTable">
        <thead>
            <tr>
                <th>Location</th>
                <th>Current Owner</th>
            </tr>
        </thead>
        <tbody>
            <!-- Table rows will be populated dynamically -->
        </tbody>
    </table>

    <script>
        // Initialize the map
        const map = L.map('map').setView([47.346416,9.525444], 4); // Center on the Game Location

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Function to add markers to the map
        function addMarkerToMap(location) {
            const owner = location.currentOwner || 'Uncaptured';
            
            function getMarkerColor(owner) {
                const colorMap = {
                    'Red Team': 'red',
                    'Blue Team': 'blue',
                    'Green Team': 'green',
                    'Purple Team': 'purple',
                    'Orange Team': 'orange',
                    'Violet Team': 'violet',
                    'Yellow Team': 'yellow',
                    'Uncaptured': 'grey'
                };

                return colorMap[owner] || 'black';
            }

            const customIcon = L.divIcon({
        className: 'custom-div-icon', // You can add your own custom class if needed
        html: `<div style="background-color: ${getMarkerColor(owner)};
                          width: 25px; height: 25px; border-radius: 50%; 
                          border: 2px solid white;"></div>`,
        iconSize: [25, 25],  // Size of the div element
        iconAnchor: [12, 12] // Center the icon
    });
            const marker = L.marker([location.lat, location.lon], {icon: customIcon}).addTo(map);
            marker.bindPopup(`<b>${location.name}</b><br>Owner: ${location.currentOwner || 'Uncaptured'}`);
        }

        async function fetchLocationStatus() {
            try {
                const response = await fetch('/api/location-status');
                const locations = await response.json();
                const tableBody = document.querySelector('#locationTable tbody');
                tableBody.innerHTML = '';
                
                // Clear existing markers
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                locations.forEach(location => {
                    const row = `
                        <tr>
                            <td>${location.name}</td>
                            <td>${location.currentOwner || 'Uncaptured'}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;

                    // Add marker to the map
                    addMarkerToMap(location);
                });

                // Adjust map view to fit all markers
                const bounds = L.latLngBounds(locations.map(loc => [loc.lat, loc.lon]));
                map.fitBounds(bounds);

            } catch (error) {
                console.error('Error fetching location status:', error);
            }
        }

        // Fetch location status when the page loads
        fetchLocationStatus();

        // Refresh the status every 30 seconds
        setInterval(fetchLocationStatus, 30000);
    </script>
</body>
</html>